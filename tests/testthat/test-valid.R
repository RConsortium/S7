test_that("validate() validates object and type recursively", {
  klass <- new_class("klass",
    properties = list(x = "double", y = "double"),
    validator = function(object) {
      c(
        if (object@x < 0) "x must be positive",
        if (object@y > 0) "y must be negative"
      )
    }
  )

  expect_snapshot(error = TRUE, {
    obj <- klass(1, -1)
    attr(obj, "x") <- -1
    validate(obj)

    attr(obj, "x") <- "y"
    validate(obj)
  })

  klass2 <- new_class("klass2", parent = klass, properties = list(z = "double"))
  expect_snapshot(error = TRUE, {
    obj <- klass2(1, -1, 1)
    attr(obj, "x") <- -1
    validate(obj)

    attr(obj, "x") <- "y"
    attr(obj, "z") <- "y"
    validate(obj)
  })
})

test_that("validate checks base type", {
  Double <- new_class("Double", parent = "double")
  x <- Double(10)
  mode(x) <- "character"

  expect_snapshot(error = TRUE, validate(x))
})

test_that("valid eventually calls the validation function only at the end", {
  obj <- range(1, 10)

  obj <- valid_eventually(
    obj,
    function(x) {
      x@start <- 11
      x@start <- 1
      x
    })

  expect_error(validate(obj), NA)
})

test_that("valid implicitly does _not_ call the validation function", {
  obj <- range(1, 10)

  obj <- valid_implicitly(
    obj,
    function(x) {
      x@start <- 11
      x
    })

  expect_error(validate(obj),
    "must be greater than"
  )
})
